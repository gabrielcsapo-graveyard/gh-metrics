#!/usr/bin/env node

var program = require('commander');
var metrics = require('../index.js');

var Table = require('markdown-table');

program
    .version(require('../package.json').version)
    .option('-u, --user [user]', 'the name of the user that you want to get metrics for.')
    .option('-t, --token [token]', 'github access token to make requests.')
    .option('-k, --keys [keys]', 'keys to be passed to make the table based on the comma seperated keys you provide.')
    .option('-s, --sort [sort]', 'key to be used to sort against the returned value')
    .option('-a, --asc', 'by default the sorting is descending if this is selected it will be ascending')
    .parse(process.argv);

if (program.user) {
    program.keys = program.keys.split(',').map(function(k) {
        return k.trim();
    }) || ['full_name', 'homepage', 'description', 'created_at', 'size'];
    metrics({
        user: program.user,
        token: program.token,
        keys: program.keys,
        sort: program.sort,
        sortAsc: program.asc ? true : false
    }, function(response) {
        var keys = Object.keys(response[0]).sort();
        var table = [keys];

        response.forEach(function(repo) {
            var row = [];
            Object.keys(repo).sort().forEach(function(key) {
                row.push(repo[key] ? JSON.stringify(repo[key]) : repo[key]);
            });
            table.push(row);
        });
        console.log(Table(table));
    });
} else {
    console.error('please specify a user\n');
}
